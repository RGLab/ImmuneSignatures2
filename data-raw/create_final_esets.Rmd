---
title: "ImmuneSignatures2: Create Final ExpressionSets from Base ExpressionSet"
author: "Evan Henrich and Helen Miller"
output: html_document
---

# Overview
The purpose of this vignette is to generate expressionSets for analysis by HIPC collaborators in the ImmuneSignatures2 project.  The base expressionSet includes all age cohorts and is not normalized across study or batch-corrected for issues like different platforms (e.g. Illumina vs Affymetrix).  Therefore, expressionSets for analysis are generated for both young and old cohorts that then are cross-study normalized and batch corrected.  The cross-study normalization is done by taking a target distribution from one platform (Affymetrix) and applying this to all samples. The batch-correction is done by using a linear-model to determining the effects of platform (e.g. Illumina Human HT-V4), platform vendor (e.g. Illumina), cell type (either Whole Blood or PBMC), and study on baseline data, then removing these effects for all timepoints.  Finally each expressionSet comes in a version with or without immune response data.  For subjects with multiple immune response data points (due to multiple assays), the preference is given to HAI then NAb then ELISA data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r load-dependencies}
library(ImmuneSignatures2) # vaccine map loaded as `vaccines`
library(Biobase)
library(dplyr)
library(data.table)
library(titer) # devtools::install_github("stefanavey/titer")
library(limma)
library(here)
```

```{r output-variables}
outputDir <- here("outputs", "virtualStudy_prod")
dataCacheDir <- here("data_cache", "virtualStudy_prod")
inputFilenamePrefix <- ""
outputFilenamePrefix <- ""
if (!dir.exists(outputDir)) stop("could not find", outputDir)
if (!dir.exists(dataCacheDir)) stop("could not find", dataCacheDir)
```


```{r global-variables}
postVaxDayRanges <- list(
  hai = c(20,46),
  neut_ab_titer = c(28,90),
  elisa = c(21,30)
)

discretizationValues <- list(
    "RBA" = c(0.3, 0.4, 0.5),
    "MFC" = c(0.3, 0.4)
)

young <- c(18,50)
  old <- c(60,91)
  
ageGroups <- list(
  young = young,
  old = old,
  extendedOld = c(max(young), max(old)),
  all = c(min(young), max(old))
)

targetDistributionVendor <- "Affymetrix"
targetDistributionExcludedStudies <- "SDY1293"
```

```{r load-base-data}
immdata_all <- readRDS(file.path(dataCacheDir,  paste0(inputFilenamePrefix, "immdata_all.rds")))
noNormEset <- readRDS(file.path(dataCacheDir, paste0(inputFilenamePrefix, "noNormEset.rds")))
```

```{r create-cross-study-normalized-version}
eset.all.norm <- crossStudyNormalize(noNormEset, 
                                     targetDistributionVendor, 
                                     targetDistributionExcludedStudies)
```

```{r create-variants-of-final-eset}
for(ageGroupName in names(ageGroups)){
  ages <- ageGroups[[ageGroupName]]
  
  # No Cross-Study Normalization, No Immune Response Calls
  eset.noNorm.noResponse <- filterEsetByAge(noNormEset, ages)
  eset.noNorm.noResponse <- removeAllNArows(eset.noNorm.noResponse)
  res <- testFinalEset(eset.noNorm.noResponse, 
                       expectResponse = FALSE, 
                       expectNormalization = FALSE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_noNorm_noResponse_eset.rds")
  filename <- file.path(dataCacheDir, paste0(outputFilenamePrefix, fullSuffix))
  saveRDS(eset.noNorm.noResponse, filename)
  
  # With Cross-Study Normalization, No Immune Response Calls
  if(grepl("old", ageGroupName, ignore.case = TRUE)){
      eset.young.norm <- filterEsetByAge(eset.all.norm, ages = ageGroups[["young"]])
      eset.young.norm <- removeAllNArows(eset.young.norm)
      
      eset.old.norm <- filterEsetByAge(eset.all.norm, ages = ageGroups[[ageGroupName]])
      eset.old.norm <- removeAllNArows(eset.old.norm)
      
      # Remove studies that do not have young cohorts and cannot be modeled
      eset.old.norm <- eset.old.norm[, !eset.old.norm$study_accession %in% c("SDY1368","SDY67") ]
      
      eset.corr.noResponse <- batchCorrect.importedModel(modelEset = eset.young.norm,
                                                         targetEset = eset.old.norm)
    }else{
      eset.norm.noResponse <- filterEsetByAge(eset.all.norm, ages)
      eset.norm.noResponse <- removeAllNArows(eset.norm.noResponse)
      eset.corr.noResponse <- batchCorrect(eset.norm.noResponse)
    }
  eset.corr.noResponse <- removeAllNArows(eset.corr.noResponse)

  
  res <- testFinalEset(eset.corr.noResponse, 
                       expectResponse = FALSE, 
                       expectNormalization = TRUE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_norm_noResponse_eset.rds")
  filename <- file.path(dataCacheDir, paste0(outputFilenamePrefix, fullSuffix))
  saveRDS(eset.corr.noResponse, filename)
  
  # Generate Immune Response Calls
  filteredImmdata <- filterImmdataByAge(immdata_all, ages)
  immdataWithResponses <- lapply(names(filteredImmdata), function(assay){
    dataWithResponses <- generateResponseCall(
      assay = assay,
      data = filteredImmdata[[assay]],
      postVaxDayRange = postVaxDayRanges[[assay]],
      discretizationValues = discretizationValues
    )
  })
  selectedImmdata <- selectResponsesToUse(immdataWithResponses)
    
  # No Cross-Study Normalization, with Immune Response Calls
  eset.noNorm.withResponse <- addResponseData(eset.noNorm.noResponse,
                                              selectedImmdata)
  res <- testFinalEset(eset.noNorm.withResponse, 
                       expectResponse = TRUE, 
                       expectNormalization = FALSE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_noNorm_withResponse_eset.rds")
  filename <- file.path(dataCacheDir, paste0(outputFilenamePrefix, fullSuffix))
  saveRDS(eset.noNorm.withResponse, filename)
  
  # With Cross-Study Normalization, with Immune Response Calls
  eset.corr.withResponse <- addResponseData(eset.corr.noResponse, 
                                            selectedImmdata)
  res <- testFinalEset(eset.corr.withResponse, 
                       expectResponse = TRUE, 
                       expectNormalization = TRUE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_norm_withResponse_eset.rds")
  filename <- file.path(dataCacheDir, paste0(outputFilenamePrefix, fullSuffix))
  saveRDS(eset.corr.withResponse, filename)
}
```


## Subject summaries by dataset
Looking at all versions of the data

```{r summarize, eval = TRUE}

summarizeEset <- function(eset) {
  d <- pData(eset)
  study_count <- length(unique(d$study_accession))
  arm_count <- length(unique(d$arm_accession))
  cohort_count <- length(unique(d$cohort))
  cohort_count <- max(arm_count, cohort_count)
  # subject_count <- length(unique(gsub("\\.\\d+", "", d$participant_id)))
  subject_count <- length(unique(d$participant_id))
  sample_count <- length(unique(d$biosample_accession))
  summary_dataset <- data.table(
    studies = study_count,
    cohorts = cohort_count, 
    subjects = subject_count, 
    samples = sample_count)
  return(summary_dataset)
}

summarizeEsetList <- function(esetList, con) {
  pdList <- lapply(esetList, pData)
  d <- rbindlist(pdList)
  if (!"arm_accession" %in% names(d)) {
    gef <- con$getDataset("gene_expression_files", original_view = TRUE)
    d <- merge(d, unique(gef[, .(participant_id, arm_accession, study_accession)]), all.x = TRUE, all.y = FALSE)
  }
  study_count <- length(unique(d$study_accession))
  cohort_count <- length(unique(d$arm_accession))
  # subject_count <- length(unique(gsub("\\.\\d+", "", d$participant_id)))
  subject_count <- length(unique(d$participant_id))
  sample_count <- length(unique(d$biosample_accession))
  summary_dataset <- data.table(
    studies = study_count,
    cohorts = cohort_count, 
    subjects = subject_count, 
    samples = sample_count)
  return(summary_dataset)
}
esets_all <- list.files(here::here(dataCacheDir), pattern = "_eset.rds")
con <- ImmuneSpaceR::CreateConnection("IS2", onTest = FALSE)
dimstudy <- Rlabkey::labkey.selectRows("https://test.immunespace.org/", 
                              folderPath = "HIPC/IS2", 
                              schemaName = "immport", 
                              queryName = "dimstudy", 
                              colSelect = c("study", "program"),
                              colNameOpt = "rname")
datasets <- lapply(file.path(dataCacheDir, esets_all), readRDS)
names(datasets) <- esets_all

datasetSummaries <- lapply(datasets, function(dataset) {
  
  d <- data.table(pData(dataset))
  d <- merge(d, dimstudy, by.x = "study_accession", by.y = "study")
  cohort_count <- length(unique(d$arm_accession))
  study_count <- length(unique(d$study_accession))
  vaccine_count <- length(unique(d$vaccine))
  vaccine_type_count <- length(unique(d$vaccine_type))
  pathogen_count <- length(unique(d$pathogen))
  
  studyProgram <- unique(d[, .(study_accession, program)])
  studyProgram[, hipc := grepl("HIPC", program)]
  hipc_studies <- sum(studyProgram$hipc)
  not_hipc_studies <- sum(!studyProgram$hipc)
  summary_datset <- data.table(
    studies = study_count, 
    vaccines = vaccine_count, 
    vaccine_types = vaccine_type_count,
    pathogens = pathogen_count,
    hipc_studies = hipc_studies,
    not_hipc_studies = not_hipc_studies)
})
datasetSummary <- rbindlist(datasetSummaries)
datasetSummary$dataset <- esets_all
consort_numbers <- readRDS(here::here(dataCacheDir, "consort_numbers.rds"))
all_norm_summary <- summarizeEsetList(c(datasets[["young_norm_noResponse_eset.rds"]], 
                                        datasets[["extendedOld_norm_noResponse_eset.rds"]]))
consort_numbers[step == "Normalize: remove studies without young cohort", 
                `:=`(studies_remaining = all_norm_summary$studies,
                     studies_affected = consort_numbers[step == "remove subjects without baseline"]$studies_remaining - all_norm_summary$studies,
                     studies_dropped = consort_numbers[step == "remove subjects without baseline"]$studies_remaining - all_norm_summary$studies,
                     cohorts_remaining = all_norm_summary$cohorts,
                     cohorts_affected = consort_numbers[step == "remove subjects without baseline"]$cohorts_remaining - all_norm_summary$cohorts,
                     cohorts_dropped = consort_numbers[step == "remove subjects without baseline"]$cohorts_remaining - all_norm_summary$cohorts,
                     subjects_remaining = all_norm_summary$subjects,
                     subjects_affected = consort_numbers[step == "remove subjects without baseline"]$subjects_remaining - all_norm_summary$subjects,
                     subjects_dropped = consort_numbers[step == "remove subjects without baseline"]$subjects_remaining - all_norm_summary$subjects,
                     samples_remaining = all_norm_summary$samples,
                     samples_affected = consort_numbers[step == "remove subjects without baseline"]$samples_remaining - all_norm_summary$samples,
                     samples_dropped = consort_numbers[step == "remove subjects without baseline"]$samples_remaining - all_norm_summary$samples
                     )]
young_norm_summary <- summarizeEset(datasets[["young_norm_noResponse_eset.rds"]])
consort_numbers[step == "Young adult dataset",
                `:=`(studies_remaining = young_norm_summary$studies,
                     cohorts_remaining = young_norm_summary$cohorts,
                     subjects_remaining = young_norm_summary$subjects,
                     samples_remaining = young_norm_summary$samples)]
extendedOld_norm_summary <- summarizeEset(datasets[["extendedOld_norm_noResponse_eset.rds"]])
consort_numbers[step == "Older adult dataset",
                `:=`(studies_remaining = extendedOld_norm_summary$studies,
                     cohorts_remaining = extendedOld_norm_summary$cohorts,
                     subjects_remaining = extendedOld_norm_summary$subjects,
                     samples_remaining = extendedOld_norm_summary$samples)]

fwrite(consort_numbers, file.path(dataCacheDir, "consort_numbers.csv"))
fwrite(datasetSummary, file.path(dataCacheDir, "dataset_summary.csv"))
```



```{r create-diagnostic-plots, eval = TRUE}
library(tidyverse)
allEset <- readRDS(file.path(dataCacheDir, paste0(outputFilenamePrefix, "all_noNorm_noResponse_eset.rds")))
ychromQCPlot <- qualityControl.failedYchromQC(allEset)
pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "ychromQC.pdf")),
    width = 8.5,
    height = 11)
ychromQCPlot
dev.off()

young <- readRDS(file.path(dataCacheDir, paste0(outputFilenamePrefix, "young_norm_noResponse_eset.rds")))

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "young_mds_byStudy.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(young)
dev.off()

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "young_mds_byYchrom.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(young, colorCol = "y_chrom_present")
dev.off()

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "young_pca_byYchrom.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(young, method = "PCA", colorCol = "y_chrom_present")
dev.off()

old <- readRDS(file.path(dataCacheDir, paste0(outputFilenamePrefix, "old_norm_noResponse_eset.rds")))

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "old_mds_byStudy.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(old)
dev.off()

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "old_mds_byYchrom.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(old, colorCol = "y_chrom_present")
dev.off()

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "old_pca_byYchrom.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(old, method = "PCA", colorCol = "y_chrom_present")
dev.off()

extendedOld <- readRDS(file.path(dataCacheDir, paste0(outputFilenamePrefix, "extendedOld_norm_noResponse_eset.rds")))

pdf(file = file.path(outputDir, paste0(outputFilenamePrefix, "extendedOld_mds_byStudy.pdf")),
    width = 8.5,
    height = 11)
qualityControl.samplePlot(extendedOld)
dev.off()
```
