---
title: "ImmuneSignatures 2 Project - Create Final ExpressionSets"
author: "Evan Henrich"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r load-dependencies}
library(ImmuneSignatures2) # vaccine map loaded as `vaccines`
library(Biobase)
library(dplyr)
library(data.table)
library(titer) # devtools::install_github("stefanavey/titer")
library(limma)
```

```{r output-variables}
outputDir <- "/home/evanhenrich/Documents/FHCRC/IS2_OUTPUT/"
inputFilenamePrefix <- "2020_06_29_"
outputFilenamePrefix <- "2020_07_01/2020_07_01_"

postVaxDayRanges <- list(
  hai = c(20,46),
  neut_ab_titer = c(28,90),
  elisa = c(21,30)
)

discretizationValues <- list(
    "RBA" = c(0.3, 0.4, 0.5),
    "MFC" = c(0.3, 0.4)
)

young <- c(18,50)
  old <- c(60,91)
  
ageGroups <- list(
  young = young,
  old = old,
  all = c(min(young), max(old))
)

targetDistributionVendor <- "Affymetrix"
targetDistributionExcludedStudies <- "SDY1293"
```

```{r load-base-data}
immdata_all <- readRDS(paste0(outputDir, "/", inputFilenamePrefix, "immdata_all.rds"))
noNormEset <- readRDS(paste0(outputDir, "/", inputFilenamePrefix, "noNormEset.rds"))
noNormEset$featureSetVendor[ noNormEset$featureSetName2 == "RNA-seq"] <- "NA" # correct data
```

```{r create-cross-study-normalized-version}
eset.all.norm <- crossStudyNormalize(noNormEset, 
                                     targetDistributionVendor, 
                                     targetDistributionExcludedStudies)
```

```{r create-variants-of-final-eset}
for(ageGroupName in names(ageGroups)){
  ages <- ageGroups[[ageGroupName]]
  
  # No Cross-Study Normalization, No Immune Response Calls
  eset.noNorm.noResponse <- filterEsetByAge(noNormEset, ages)
  eset.noNorm.noResponse <- removeAllNArows(eset.noNorm.noResponse)
  res <- testFinalEset(eset.noNorm.noResponse, 
                       expectResponse = FALSE, 
                       expectNormalization = FALSE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_noNorm_noResponse_eset.rds")
  filename <- paste0(outputDir, outputFilenamePrefix, fullSuffix)
  saveRDS(eset.noNorm.noResponse, filename)
  
  # With Cross-Study Normalization, No Immune Response Calls
  if(ageGroupName == "old"){
      eset.young.norm <- filterEsetByAge(eset.all.norm, ages = ageGroups[["young"]])
      eset.young.norm <- removeAllNArows(eset.young.norm)
      
      eset.old.norm <- filterEsetByAge(eset.all.norm, ages = ageGroups[["old"]])
      eset.old.norm <- removeAllNArows(eset.old.norm)
      
      # Remove studies that do not have young cohorts and cannot be modeled
      eset.old.norm <- eset.old.norm[, !eset.old.norm$study_accession %in% c("SDY1368","SDY67") ]
      
      eset.corr.noResponse <- batchCorrect.importedModel(modelEset = eset.young.norm,
                                                         targetEset = eset.old.norm)
    }else{
      eset.norm.noResponse <- filterEsetByAge(eset.all.norm, ages)
      eset.norm.noResponse <- removeAllNArows(eset.norm.noResponse)
      eset.corr.noResponse <- batchCorrect(eset.norm.noResponse)
    }
  eset.corr.noResponse <- removeAllNArows(eset.corr.noResponse)
  
  res <- testFinalEset(eset.corr.noResponse, 
                       expectResponse = FALSE, 
                       expectNormalization = TRUE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_norm_noResponse_eset.rds")
  filename <- paste0(outputDir, outputFilenamePrefix, fullSuffix)
  saveRDS(eset.corr.noResponse, filename)
  
  # Generate Immune Response Calls
  filteredImmdata <- filterImmdataByAge(immdata_all, ages)
  immdataWithResponses <- lapply(names(filteredImmdata), function(assay){
    dataWithResponses <- generateResponseCall(
      assay = assay,
      data = filteredImmdata[[assay]],
      postVaxDayRange = postVaxDayRanges[[assay]],
      discretizationValues = discretizationValues
    )
  })
  selectedImmdata <- selectResponsesToUse(immdataWithResponses)
    
  # No Cross-Study Normalization, with Immune Response Calls
  eset.noNorm.withResponse <- addResponseData(eset.noNorm.noResponse,
                                              selectedImmdata)
  res <- testFinalEset(eset.noNorm.withResponse, 
                       expectResponse = TRUE, 
                       expectNormalization = FALSE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_noNorm_withResponse_eset.rds")
  filename <- paste0(outputDir, outputFilenamePrefix, fullSuffix)
  saveRDS(eset.noNorm.withResponse, filename)
  
  # With Cross-Study Normalization, with Immune Response Calls
  eset.corr.withResponse <- addResponseData(eset.corr.noResponse, 
                                            selectedImmdata)
  res <- testFinalEset(eset.corr.withResponse, 
                       expectResponse = TRUE, 
                       expectNormalization = TRUE, 
                       ages)
  checkFinalTestResults(res)
  
  fullSuffix <- paste0(ageGroupName, "_norm_withResponse_eset.rds")
  filename <- paste0(outputDir, outputFilenamePrefix, fullSuffix)
  saveRDS(eset.corr.withResponse, filename)
}
```

```{r create-diagnostic-plots}
allEset <- readRDS(paste0(outputDir, outputFilenamePrefix, "all_noNorm_noResponse_eset.rds"))
genderQCPlot <- qualityControl.failedGenderImputation(allEset)
genderQCPlot

young <- readRDS(paste0(outputDir, outputFilenamePrefix, "young_norm_noResponse_eset.rds"))
qualityControl.samplePlot(young)

old <- readRDS(paste0(outputDir, outputFilenamePrefix, "old_norm_noResponse_eset.rds"))
qualityControl.samplePlot(old)
```
