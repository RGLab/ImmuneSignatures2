---
title: "ImmuneSignatures2: Reproduction of analysis and figures for pre-vaccination manuscript"
output: 
  html_document: 
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
date: "`r format(Sys.time(), '%d %B, %Y')`"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE,
                      warning = FALSE)
```

```{r, libraries}
suppressPackageStartupMessages({
  library(package = "knitr")
  library(package = "Biobase")
  library(package = "RColorBrewer")
  library(package = "tidyverse")
  library(package = "ggbeeswarm")
  library(package = "pvca") # dleelab/pvca
  library(package = "lme4")
  library(package = "cluster")
  library(package = "ComplexHeatmap") # Bioc Install
  library(package = "ImmuneSignatures2")
  library(package = "cowplot")
  library(here)
})
```


```{r, global-variables, echo=FALSE}
dataCacheDir <- here("data_cache")
datePrefix <- "2020_12_23_newAnno_"
```

# Setup

These figures only look at the "Young" cohort that is defined as 18 to 50 years old and the "Extended Old" cohort of 50 to 90 years old.  The "Old" cohort (not used here) was 60 to 90 years old.

```{r, read-esets}
subsetToCompleteGenes <- function(eset) {
  # only include complete cases
  # TODO: Check in with IS2 folks about this... SHould I update the datsets?
  completeGenes <- complete.cases(exprs(eset))
  eset[completeGenes]
}

noRespGEFile <- file.path(dataCacheDir, paste0(datePrefix,"extendedOld_norm_noResponse_eset.rds"))
old.NoResp <- subsetToCompleteGenes(readRDS(file = noRespGEFile))


noRespGEFile <- file.path(dataCacheDir, paste0(datePrefix,"young_norm_noResponse_eset.rds"))
young.NoResp <- subsetToCompleteGenes(readRDS(file = noRespGEFile))

withRespGEFile <- file.path(dataCacheDir, paste0(datePrefix,"young_norm_withResponse_eset.rds"))
young.WithResp <- subsetToCompleteGenes(readRDS(file = withRespGEFile))
```


```{r, set-standard-colors, echo=FALSE}
# Fig 1
set3colors <- brewer.pal("Set3", n = 12)
colors.fig1a <- c(set3colors[c(2, 11, 3, 12, 8)], 
                "black", 
                set3colors[c(7, 6, 5, 1, 4, 9, 10)])

# Other Figures
getPalette <- colorRampPalette(c(brewer.pal(name = "Set3", n = 10),
				                         brewer.pal(name = "Dark2", n = 4)))
vaccines <- unique(paste0(young.NoResp$pathogen, 
                          " (", young.NoResp$vaccine_type, ")"))
vaccine2color <- getPalette(n = length(vaccines)) %>%
  setNames(nm = sort(vaccines))
```


# Figures

## Figure 1

### Figure 1a
__caption__
...any other description...





## Perform Sample Level Enrichment Analysis on hallmark+BTM genesets
*Author: * Slim Fourati

Pre-Processing:
Microarray probes may have different affinities for their target mRNA and
thus the itensities can't be compared between probes inside the same sample.
A way to correct for that is to scale each probe to a mean of 0 and a standard-deviation
of 1.

The following looks only at pre-vaccination timepoints
```{r, check-cached-slea}
  sleaFile <- file.path(dataCacheDir, "sleaSet.rds")
  sleaCached <- file.exists(sleaFile)
  if(sleaCached){
    sleaSet <- readRDS(sleaFile)
  }
```

```{r, slea, eval=!sleaCached}
batch <- interaction(young.NoResp$study_accession,
                     young.NoResp$matrix,
                     drop = TRUE)
scaledMat <- by(data = t(exprs(young.NoResp)),
                INDICES = batch,
                FUN = function(x) scale(x)) %>%
  do.call(what = rbind) %>%
  t()
scaledMat <- scaledMat[, sampleNames(young.NoResp)]

# SLEA (Ref: Lopez-Bigas N. et al. (2008) Genome Biol.)
B <- 100
flag <- lapply(all_genesets, FUN = intersect, y = rownames(scaledMat)) %>%
  sapply(FUN = length)
zscoreMat <- sapply(all_genesets, FUN = function(gs) {
  gs <- intersect(gs, rownames(scaledMat))
  ngenes <- length(gs)
  mu <- colMeans(scaledMat[gs, , drop = FALSE], na.rm = TRUE)
  muPermut <- mclapply(1:B, FUN = function(seed) {
    set.seed(seed = seed)
    muHat <- colMeans(scaledMat[sample.int(nrow(scaledMat), ngenes), , drop = FALSE],
                      na.rm = TRUE)
    return(value = muHat)
  })
  muPermut <- do.call(what = rbind, args = muPermut)
  zscore <- (mu - colMeans(muPermut, na.rm = TRUE)) /
    apply(muPermut, MARGIN = 2, FUN = sd, na.rm = TRUE)
  return(value = zscore)
})
```

```{r, create-slea-eset, eval=!sleaCached}
sleaSet <- ExpressionSet(assayData = t(zscoreMat),
                         phenoData = AnnotatedDataFrame(pData(young.NoResp)))
saveRDS(sleaSet, file = sleaFile)
```

```{r define-genesets}
inflamGS <- c("HALLMARK_INFLAMMATORY_RESPONSE",
              "HALLMARK_COMPLEMENT",
              "HALLMARK_IL6_JAK_STAT3_SIGNALING",
              "HALLMARK_TNFA_SIGNALING_VIA_NFKB")
```

## Figure 2: Heatmap of SLEA zscore on pre-vaccination samples
*Author: * Slim Fourati
```{r, fig2, fig.width=8, fig.height=6}
zscoreTemp <- exprs(sleaSet)[, sleaSet$study_time_collected <= 0]

# remove genesets with missing symbols in virtual study
zscoreTemp <- zscoreTemp[rowMeans(is.na(zscoreTemp)) < 1, ]

# for representation purpsis only present top 200 varying genesets
varLS <- apply(zscoreTemp, MARGIN = 1, FUN = var)
zscoreTemp <- zscoreTemp[order(varLS, decreasing = TRUE)[1:200], ]

# cutree into three groups (see gap statistic analysis
set.seed(seed = 23)
tree_col  <- kmeans(x = t(zscoreTemp), centers = 3)
gr <- tree_col$cluster

# relabel cluster based on inflammatory genesets
df.fig2 <- data.frame(mu = colMeans(zscoreTemp[inflamGS, ])) %>%
  rownames_to_column()

df.fig2 <- data.frame(grn = gr) %>%
  rownames_to_column() %>%
  merge(x = df.fig2) %>%
  merge(y = pData(sleaSet),
        by.x = "rowname",
        by.y = "uid")

df.fig2 %>%
  group_by(grn) %>%
  summarize(q2 = median(mu)) %>%
  ungroup() %>%
  mutate(gr = ifelse(q2 %in% min(q2),
                     yes = "low",
                     no  = NA),
         gr = ifelse(q2 %in% max(q2) & is.na(gr),
                     yes = "high",
                     no  = gr),
         gr = ifelse(is.na(gr),
                     yes = "mid",
                     no  = gr),
         gr = factor(gr, levels = c("low", "mid", "high"))) %>%
  merge(x = df.fig2,
        by = "grn") %>%
  column_to_rownames(var = "rowname") -> df.fig2

df.fig2 <- df.fig2[colnames(zscoreTemp), ]

# Remove names of unwanted cells in plot
rowLabels <- rownames(zscoreTemp)

targetCellNames <- "B.cell|E2F|T.cell|MYC| NK| Interferon|STAT|migration|Monocytes| DC|Neutrophiles"

unwantedCells <- !grepl(pattern = targetCellNames, 
                        rownames(zscoreTemp),
                        ignore.case = TRUE)

rowLabels[ unwantedCells ] <- ""

# generate heatmap annotation
ha <- df.fig2 %>%
      rownames_to_column() %>%
      mutate(inflam.gs = findInterval(mu,
                                      vec = quantile(mu,
    				                                         probs = c(0, 0.33, 0.66, 1)),
    				                          rightmost.closed = TRUE),
             inflam.gs = paste0("tier", inflam.gs)) %>%
      select(rowname, inflam.gs) %>%
      column_to_rownames() %>%
      .[colnames(zscoreTemp), , drop = FALSE] %>%
      HeatmapAnnotation(df = ., 
                        col = list(inflam.gs = c(tier1 = "yellow",
                                                 tier2 = "orange",
                                                 tier3 = "red")))

Heatmap(matrix                      = zscoreTemp,
      	row_names_side              = "left", 
      	show_column_names           = FALSE,
      	column_split                = df.fig2$gr,
      	show_row_dend               = FALSE,
      	name                        = "SLEA z-score",
      	row_labels                  = rowLabels,
      	row_names_gp                = gpar(fontsize = 8),
      	top_annotation              = ha)
```

```{r, append-gr-sleaset, echo=FALSE}
sleaSet$gr <- df.fig2$gr [match(sleaSet$participant_id, df.fig2$participant_id)]
```

## Figure s2
### Figure s2a: Determine optimal number of cluster using the Gap statistic
*Author: * Slim Fourati
```{r, fig-s2a}
clusGapFile <- file.path(dataCacheDir, "clusGap.rds")
if(!file.exists(clusGapFile)){
  set.seed(seed = 23)
  fit <- clusGap(t(zscoreTemp), kmeans, K.max = 10)
  saveRDS(fit, file = clusGapFile)
}else{
  fit <- readRDS(clusGapFile)
}

plot(fit)
print(fit, method = "firstSEmax")
```


### Assess association with clinical variable
```{r, stat-clinical-vars}
# continuous variable
df.fig2 %>%
  select(gr,
         age_reported,
         age_imputed) %>%
  pivot_longer(cols = -gr) %>%
  group_by(name) %>%
  do(p = kruskal.test(formula = value~gr,
                      data    = .)$p.value) %>%
  ungroup() %>%
  mutate(p = unlist(p))

# categorical variable
df.fig2 %>%
   select(gr,
          study_time_collected,
          gender, # TODO: Use ychrom_present? 
          race,
          ethnicity,
          exposure_material_reported,
          matrix,
          study_accession,
          Hispanic,
          White,
          Asian,
          Black,
          cell_type,
          cohort,
          featureSetName,
          featureSetName2,
          featureSetVendor,
          vaccine,
          vaccine_type,
          adjuvant,
          pathogen) %>%
  sapply(FUN = as.character) %>%
  as.data.frame() %>%
  pivot_longer(cols = -gr) %>%
  group_by(name) %>%
  do(p = {
    fit <- try(fisher.test(table(.$value, .$gr),
                           simulate.p.value = TRUE),
               silent = TRUE)
    if ("try-error" %in% class(fit)) {
      NA
    } else {
      fit$p.value
    }
  }) %>%
  ungroup() %>%
  mutate(p = unlist(p), adj.p = p.adjust(p, method = "BH"))
```


### Figure s2b: Stability of the signature over time
*Author: * Slim Fourati
```{r, fig-s2b, fig.width=5.9, fig.height=4.72}
df.fig2sb <- df.fig2 %>%
            filter(mu < 4.5 & mu > -4.5) %>% # remove outlier
            filter(duplicated(participant_id) |
                   duplicated(participant_id, fromLast = TRUE))

df.fig2sb %>%
  filter(study_accession %in% c("SDY80", "SDY180")) %>%
  arrange(participant_id, study_time_collected) %>%
  wilcox.test(formula = mu ~ study_time_collected,
              data    = .,
              paired  = TRUE)

df.fig2sb %>%
  filter(study_accession %in% c("SDY80", "SDY180")) %>%                            
  select(participant_id, gr, mu, study_time_collected) %>%
  pivot_wider(names_from  = study_time_collected,
              values_from = c(gr, mu))  %>%
  mutate(stable = (`gr_-7` == `gr_0`) | abs(`mu_0`-`mu_-7`)< 1) %>%
  group_by(stable) %>%
  summarize(n = n())

df.fig2sb %>%
  filter(study_accession %in% c("SDY80", "SDY180")) %>%                            
  select(participant_id, gr, mu, study_time_collected) %>%
  pivot_wider(names_from  = study_time_collected,
              values_from = c(gr, mu))  %>%
  mutate(stable = (`gr_-7` == `gr_0`) | abs(`mu_0`-`mu_-7`)< 1) %>%
  select(participant_id, stable) %>%
  merge(x = df.fig2sb, by = "participant_id", all.x = TRUE) -> df.fig2sb

ggplot(data = df.fig2sb,
        mapping = aes(x = factor(study_time_collected), y = mu)) +
        geom_point(mapping = aes(color = gr)) +
        geom_line(mapping = aes(group = participant_id,
                                linetype  = stable)) +
        scale_color_discrete(name = "pre-vax cluster") +
        labs(x = "study_time_collected",
             y = "Inflammatory genesets (SLEA z-score)") +
        theme_bw()
```

## Figure 3

### Figure 3 Helper Functions
```{r fig3-helper-functions}
getSleaPDSubset.byGS <- function(geneset){
  pd <- pData(sleaSet)
  pd$mu <- colMeans(exprs(sleaSet)[geneset, ])
  pd <- pd[ !is.na(pd$gr), ]
}

getSleaPDSubset.byGenes <- function(genes){
  df <- exprs(young.NoResp)[genes, ] %>%
          as.data.frame() %>%
          rownames_to_column(var = "gene") %>%
          pivot_longer(cols = -gene, names_to = "uid") %>%
          merge(y = pData(sleaSet), by = "uid") %>%
          filter(!is.na(gr))
}

plotSLEASubsetByTime.byGS <- function(pd, ylabel){
  ggplot(data = pd,
          mapping = aes(x = study_time_collected, y = mu, color = gr)) +
          geom_line(mapping = aes(group = participant_id),
                    alpha = 0.1) +
          geom_hline(yintercept = 0, color = "grey", size = 2) +
          geom_smooth(method = "loess", formula = "y~x", color = "black") +
          facet_wrap(facets = ~gr) +
          scale_x_continuous(limits = c(0, 28)) +
          labs(y = ylabel,
               x = "Time after vaccination (days)") +
          theme_bw() +
          theme(axis.text    = element_text(size = 15),
                strip.text   = element_text(size = 20),
                axis.title.x = element_text(size = 20),
                legend.pos   = "none",
                panel.grid  = element_blank())
}

plotSLEASubsetByTime.byGene <- function(df){
  q2DF <- df %>%
          group_by(gene) %>%
          summarize(q2 = median(value))
  
  ggplot(data = df,
          mapping = aes(x = study_time_collected, y = value, color = gr)) +
          geom_line(mapping = aes(group = participant_id),
                    alpha = 0.1) +
          geom_hline(data    = q2DF,
                     mapping = aes(yintercept = q2),
                     color   = "grey") +
          geom_smooth(method = "loess", formula = "y~x", color = "black") +
          facet_grid(facets = gene~gr) +
          scale_x_continuous(limits = c(0, 28)) +
          scale_y_continuous(limits = c(7, 10.5)) +
          labs(y = "log2 intensity (ComBat)") +
          theme_bw() +
          theme(axis.text    = element_text(size = 15),
                strip.text   = element_text(size = 20),
                axis.title.x = element_text(size = 20),
                legend.pos   = "none",
                panel.grid  = element_blank())
}
```

### Figure 3a: Plot SLEA z-score of inflammatory genesets over time
*Author: * Slim Fourati
```{r fig-3a, fig.width=6.92, fig.height=2.96, warning=FALSE}
pd.fig3a <- getSleaPDSubset.byGS(inflamGS)
plotSLEASubsetByTime.byGS(pd.fig3a, "Inflammatory pathways (SLEA z-score)")
```

### Figure s3a: Plot canonical inflammatory genes over time
*Author: * Slim Fourati
```{r fig-s3a, fig.width=6.53, fig.height=5.47, warning=FALSE}
inflamGenes <- c("IL1B", "NLRP3", "TNFAIP2")
df.figs3a <- getSleaPDSubset.byGenes(inflamGenes)
plotSLEASubsetByTime.byGene(df.figs3a)
```

### Figure s3b: Plot SLEA z-score of interferon genesets over time
*Author: * Slim Fourati
```{r fig-s3b, fig.width=6.92, fig.height=2.96, warning=FALSE}
interferonGS  <- c("HALLMARK_INTERFERON_ALPHA_RESPONSE",
                   "HALLMARK_INTERFERON_GAMMA_RESPONSE")
pd.figs3b <- getSleaPDSubset.byGS(interferonGS)
plotSLEASubsetByTime.byGS(pd.figs3b, "Interferon-stimulated genes (SLEA z-score)")
```

### Figure s3b (cont): Plot canonical interferon-regulated genes over time
*Author: * Slim Fourati
```{r fig-s3b-part2}
isgGenes <- c("STAT2", "IRF9", "MX1")
df.figs3b2 <- getSleaPDSubset.byGenes(isgGenes)
plotSLEASubsetByTime.byGene(df.figs3b2)
```

### Figure 3c: Plot SLEA z-score of B cell genesets over time
*Author: * Slim Fourati
```{r, fig3c, fig.width=6.92, fig.height=2.96, warning=FALSE}
bcellGS <- c("enriched in B cells (I) (M47.0)",
             "enriched in B cells (V) (M47.4)",
             "plasma cells & B cells, immunoglobulins (M156.0)")
pd.fig3c <- getSleaPDSubset.byGS(bcellGS)
plotSLEASubsetByTime.byGS(pd.fig3c, "B cells (SLEA z-score)")
```

### Figure s3c: Plot canonical B cell markers over time
*Author: * Slim Fourati
```{r, fig-s3c, fig.width=6.53, fig.height=5.47, warning=FALSE}
bcellGenes <- c("CD79A", "CD79B", "BANK1")
df.figs3c <- getSleaPDSubset.byGenes(bcellGenes)
plotSLEASubsetByTime.byGene(df.figs3c)
```

## Figure 4

### Figure 4a: Plot MFC based on inflamDF
*Author: * Slim Fourati
```{r, fig-4a, warning=FALSE, fig.width=4.4, fig.height=4.6}
pd.fig4a <- pData(sleaSet)[sleaSet$study_time_collected <= 0, ]

df.fig4a <- pd.fig4a %>%
              merge(y = distinct(select(pData(young.WithResp), 
                                        participant_id, MFC, MFC_p30))) %>%
                group_by(study_accession) %>%
                mutate(sMFC = scale(MFC),
                       vaccine = paste0(pathogen,".", vaccine_type),
                       vaccine = ifelse(pathogen %in% "Meningococcus",
                                        yes = "Meningococcus",
                                        no  = vaccine))

ggplot(data = df.fig4a,
       mapping = aes(x = factor(gr), y = sMFC)) +
       geom_beeswarm(cex = 1.1, size = 0.75) +
       geom_boxplot(outlier.color = "transparent", 
                    fill = "transparent", 
                    col = "red") +
       labs(x = "Prevax inflammatory cluster") +
       theme_bw()

kruskal.test(x = df.fig4a$sMFC, g = df.fig4a$gr)

pairwise.wilcox.test(x = df.fig4a$sMFC, 
                     g = df.fig4a$gr, 
                     p.adjust.method = "none") %>%
    print()
```


### Table s4: Difference in MFC between low and high inflam. group per vaccine
*Author: * Slim Fourati
```{r, table-s4, warning=FALSE}
df.fig4a %>%
  filter(age_imputed < 50 & gr %in% c("low", "high")) %>%
  group_by(vaccine) %>%
  do(n = nrow(.),
    estimate = {
        fit <- try(wilcox.test(formula = sMFC~gr, 
                               data = ., 
                               conf.int = TRUE),
                   silent = TRUE)
        if ("try-error" %in% class(fit)) {
          NA
        } else {
          fit$estimate
        }
    },
    p = {
        fit <- try(wilcox.test(formula = sMFC~gr, data = ., conf.int = TRUE),
                 silent = TRUE)
      if ("try-error" %in% class(fit)) {
        NA
      } else {
        fit$p.value
      }
    }) %>%
    mutate(n = unlist(n),
           estimate = unlist(estimate), 
           p = unlist(p)) %>%
    print()
```


### Figure 4-split: Split by Influenza.Inactivated or others
*Author: * Slim Fourati
```{r, fig4-split-fluiav}
plotTemp <- filter(df.fig4a, !(vaccine %in% c("Pneumococcus.Polysaccharide",
                                              "Smallpox.Live attenuated",
                                              "Tuberculosis.Recombinant Viral Vector")))

ggplot(data = filter(plotTemp, age_imputed < 50),
        mapping = aes(x = factor(gr), y = sMFC)) +
        geom_beeswarm() +
        geom_boxplot(outlier.color = "transparent", 
                     fill = "transparent", 
                     col = "red") +
        labs(x = "Prevax inflammatory cluster", 
             title = "age < 50") +
        facet_wrap(facets = ~ifelse(test= vaccine %in% "Influenza.Inactivated",
                                    yes = "Influenza.Inactivated",
                                    no = "others")) +
        theme_bw()

filter(plotTemp, vaccine %in% "Influenza.Inactivated") %>%
  (function(p) { pairwise.wilcox.test(x = p$sMFC,
                                      g = p$gr,
                                      p.adjust.method = "none")}) %>%
  print()

filter(plotTemp, vaccine != "Influenza.Inactivated") %>%
  (function(p) { pairwise.wilcox.test(x = p$sMFC,
                                      g = p$gr,
                                      p.adjust.method = "none")}) %>%
  print()
```
